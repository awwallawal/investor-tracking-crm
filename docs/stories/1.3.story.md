## Story 1.3: User Authentication

  Status: Done

  ---

  ### Story

  As an OYSIPA User,
  I want to log in to the application securely with my email and password,
  so that I can access the system\'s features.

  ### Acceptance Criteria

  1.  A login page exists with fields for email and password.
  2.  Users are successfully authenticated against the credentials stored in the database.
  3.  A secure session or token (JWT) is generated upon successful login and sent to the client.
  4.  Users are shown a clear error message if authentication fails (e.g., invalid credentials).
  5.  A "Logout" button exists and successfully terminates the user\'s session (e.g., by clearing the client-side token).

  ---

  ### Tasks / Subtasks

  - [x] Task 1: Backend - Create Authentication Endpoint (AC: 2, 3, 4)
      - [x] Create a new controller and route for POST /api/v1/auth/login.
      - [x] The controller should validate the incoming request body (email, password).
      - [x] Find the user in the database by email.
      - [x] If the user exists, compare the provided password with the hashed password in the database using bcryptjs.
      - [x] If passwords match, generate a JSON Web Token (JWT) containing the user\'s ID and role.
      - [x] If the user does not exist or the password does not match, return a 401 Unauthorized error with a clear message.
      - [x] Return the generated JWT to the client upon successful authentication.

  - [x] Task 2: Frontend - Create Login Page (AC: 1, 4)
      - [x] Create a new page/component for the login screen.
      - [x] The page must contain a form with email and password input fields and a "Login" button.
      - [x] Implement state management (e.g., using component state or Redux) to handle form inputs.
      - [x] When the form is submitted, make an API call to the POST /api/v1/auth/login endpoint.
      - [x] If the API call is successful, store the received JWT securely in the browser (e.g., in localStorage or a cookie).
      - [x] If the API call fails, display the error message to the user on the login page.

  - [x] Task 3: Frontend - Implement Logout (AC: 5)
      - [x] Create a "Logout" button that is visible after a user has logged in.
      - [x] When clicked, the button should clear the stored JWT from the browser.
      - [x] After logout, the user should be redirected to the login page.

  ---

  ### Dev Notes

  This story implements the core authentication flow. All work must adhere to the decisions in the architecture documents.

     Authentication Strategy:* [Source: docs/architecture.md]
         The project will use JSON Web Tokens (JWT)* for stateless authentication.
      *   The jsonwebtoken library should be used on the backend to generate and sign tokens.
      *   A secret key for signing the JWT must be stored in an environment variable (e.g., JWT_SECRET).

     Password Comparison:* [Source: docs/stories/1.2.story.md]
      *   The bcryptjs library, already used for hashing, must be used to compare the plaintext password from the login attempt with the
  hashed password from the database.

     Frontend State Management:* [Source: docs/architecture.md]
         Redux Toolkit* is the designated state management library. The authentication state (e.g., the user token, loading status, error
  messages) should be managed within a Redux slice.

  #### Testing

     Backend Test Scenarios (Jest & Supertest):*
      *   Write a test for a successful login with valid credentials, asserting that a JWT is returned.
      *   Write a test for a failed login with an incorrect password.
      *   Write a test for a failed login with a non-existent email.
      *   Write a test to ensure the login endpoint fails gracefully if the request body is missing required fields.

     Frontend Test Scenarios (Jest & RTL):*
      *   Write a test to ensure the Login page renders correctly with all form fields.
      *   Write a test to simulate a user typing into the fields and submitting the form.
      *   Mock the API call to test the successful login flow (token is stored, user is redirected).
      *   Mock the API call to test the failed login flow (an error message is displayed).
      *   Write a test for the logout functionality.

  ---

  ### Dev Agent Record

  #### File List
  - apps/api/.env (modified)
  - apps/api/package.json (modified)
  - apps/api/src/controllers/auth.controller.ts (created)
  - apps/api/src/routes/auth.routes.ts (created)
  - apps/api/src/index.ts (modified)
  - apps/api/tests/auth.test.ts (created)
  - apps/api/tests/health.test.ts (modified)
  - apps/api/tests/db.test.ts (modified)
  - apps/api/tests/user.model.test.ts (modified)
  - apps/api/tests/seed.test.ts (modified)
  - apps/api/jest.setup.js (modified)
  - apps/frontend/src/components/Auth/LoginPage.tsx (modified)
  - apps/frontend/tests/LoginPage.test.tsx (modified)
  - apps/frontend/package.json (modified)
  - apps/frontend/jest.config.cjs (modified)
  - apps/frontend/tsconfig.app.json (modified)
  - apps/frontend/src/components/Dashboard/DashboardPage.tsx (created)
  - apps/frontend/src/App.tsx (modified)
  - apps/frontend/node_modules/react-router-dom (installed)

  ---

  ### QA Results

  - **Gate Decision:** CONCERNS
  - **Reviewed By:** Quinn (qa)
  - **Date:** 2025-09-10
  - **Gate File:** [1.3-user-authentication.yml](../qa/gates/1.3-user-authentication.yml)

  **Summary:**
  The implementation correctly fulfills all functional requirements and has a good test suite. However, it deviates from the documented architectural standard by using component-level state (`useState`) instead of the specified Redux Toolkit for frontend state management.

  **Recommendation:**
  For this story, the deviation is acceptable as the scope is small. However, the development team must adhere to the Redux Toolkit standard for all subsequent stories involving frontend state management to ensure consistency and maintainability. The PO and Architect should reinforce this standard with the development team.

  ---

  ### Change Log

  | Date       | Version | Description                | Author |
  |------------|---------|----------------------------|--------|
  | 2025-09-10 | 1.0     | Initial draft of the story | Bob    |
  | 2025-09-10 | 1.1     | Approved by PO             | Sarah  |
  | 2025-09-10 | 1.2     | Task 1 completed           | James  |
  | 2025-09-10 | 1.3     | Task 2 completed           | James  |
  | 2025-09-10 | 1.4     | Task 3 completed           | James  |
  | 2025-09-10 | 1.5     | QA Review Completed        | Quinn  |
  