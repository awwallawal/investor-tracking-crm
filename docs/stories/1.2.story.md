## Story 1.2: User Model & Database Setup

**Status:** Done

---

### Story

*As a* System,
*I want* the database schema for the User model to be defined and created,
*so that* user information can be securely persisted for authentication and authorization.

### Acceptance Criteria

1.  A connection to the database is successfully configured and established.
2.  A `User` table/collection is created in the database with fields for at least: ID, name, email, password (hashed), and role (`Director-General`, `Portal Administrator`, `Staff`).
3.  A script or seeding process is created to initialize the database with the first Director-General user account.

---

### Tasks / Subtasks

- [x] **Task 1: Database Integration** (AC: 1)
    - [x] Choose and install a database client library (e.g., `pg` for PostgreSQL, `mysql2` for MySQL, `mongodb` for MongoDB).
    - [x] Implement a database connection module.
    - [x] Configure environment variables for database connection strings (e.g., `DATABASE_URL`).
    - [x] Add a health check or status endpoint to verify database connectivity.

- [x] **Task 2: User Model and Migration** (AC: 2)
    - [x] Choose and install an ORM or schema definition tool (e.g., Prisma, Sequelize, Mongoose).
    - [x] Define the `User` schema with all required fields and types.
    - [x] Create a migration file to generate the `User` table/collection in the database.
    - [x] Write a script to run the migration.

- [x] **Task 3: Database Seeding** (AC: 3)
    - [x] Create a script to seed the database.
    - [x] The script should create one user with the `Director-General` role.
    - [x] Ensure the password for the seed user is properly hashed.

---

### Dev Notes

This story establishes the database connection and the core `User` model. All work must adhere to the decisions in the architecture documents.

*   **Database Technology:** [Source: `docs/architecture/3-tech-stack.md`]
    *   The project will use **MongoDB** as its database.
    *   The recommended library for interacting with MongoDB in a Node.js/Express environment is **Mongoose**. The development agent should use Mongoose to define the schema and connect to the database.

*   **Database Connection:** [Source: AC #1]
    *   The connection logic should be encapsulated in its own module (e.g., `src/config/db.ts`).
    *   The connection string must be managed via an environment variable, `DATABASE_URL`.

*   **User Schema Definition:** [Source: `docs/architecture/4-data-models.md`]
    *   A new Mongoose schema and model for `User` should be created in a file like `src/models/User.model.ts`.
    *   The schema must include the following fields:
        *   `name`: `String`, required.
        *   `email`: `String`, required, unique.
        *   `password`: `String`, required. This field must be hashed before saving.
        *   `role`: `String`, required, must be one of `'Staff'`, `'Portal Administrator'`, or `'Director-General'`. A Mongoose `enum` is appropriate here.
    *   Mongoose automatically handles `_id`, `createdAt`, and `updatedAt` fields.

*   **Password Hashing:**
    *   The `bcryptjs` library is recommended for hashing user passwords before they are stored in the database. This should be implemented as a pre-save hook in the Mongoose schema.

#### Testing

*   **Framework:** [Source: `docs/architecture/3-tech-stack.md`]
    *   All tests should be written using **Jest**.

*   **Test Scenarios:**
    *   **Database Connection:** Write a test that attempts to connect to and disconnect from a test database to verify the connection logic.
    *   **User Model Validation:**
        *   Write a test to ensure a new `User` can be created successfully with valid data.
        *   Write tests to ensure the model throws validation errors for missing required fields (e.g., `name`, `email`, `password`, `role`).
        *   Write a test to ensure the `email` field must be unique.
        *   Write a test to confirm that a user's password is automatically hashed upon saving and is never stored in plain text.
    *   **Seeding Script:** Write a test to verify that the seeding script runs successfully and creates exactly one `Director-General` user.

---

### Dev Agent Record

#### File List
- `apps/api/.env` (created)
- `apps/api/src/models/User.model.ts` (created)
- `apps/api/src/scripts/seed.ts` (created)
- `apps/api/tests/user.model.test.ts` (created)
- `apps/api/tests/seed.test.ts` (created)
- `apps/api/package.json` (modified)
- `apps/api/src/index.ts` (modified)
- `apps/api/tests/health.test.ts` (modified)

---

### Change Log

| Date       | Version | Description                | Author |
|------------|---------|----------------------------|--------|
| 2025-09-09 | 1.0     | Initial draft of the story | Sarah  |
| 2025-09-10 | 1.1     | Completed all tasks        | James  |
| 2025-09-10 | 1.2     | Approved by QA             | Quinn  |
| 2025-09-10 | 2.0     | Approved and closed by PO  | Sarah  |

---

### QA Results

**Gate Status:** PASS

**Reviewed By:** Quinn (QA)

**Date:** 2025-09-10

**Summary:**
The implementation is robust, fully meets all acceptance criteria, and is supported by a comprehensive suite of automated tests. The code is clean, well-structured, and adheres to project standards.

**Reference:**
- [Quality Gate Report for Story 1.2](docs/qa/gates/1.2-user-model-database-setup.yml)

